import FreeQueue from"./lib/free-queue.js";import{createTestIR,fetchAudioFileToF32Array}from"./ir-helper.js";import{QUEUE_SIZE}from"./constants.js";import Assets from"./assets.js";export const gpuAudio=()=>{const e=new FreeQueue(QUEUE_SIZE,1),t=new FreeQueue(QUEUE_SIZE,1),o=new Int32Array(new SharedArrayBuffer(1*Int32Array.BYTES_PER_ELEMENT));let n=null,r=null,s=!1,a=null,i=!1,u=null,l=null;const d=async()=>{i?(n.suspend(),i=!1,a.textContent="START"):((async()=>{if(s)return;console.assert(n);let a=null,i=null;l&&(a=l.value,i="TEST"===a?createTestIR():await fetchAudioFileToF32Array(n,a),l.disabled=!0),r.postMessage({type:"init",data:{inputQueue:e,outputQueue:t,atomicState:o,irArray:i,sampleRate:n.sampleRate}}),console.log("[main.js] initializeWorkerIfNecessary(): "+a),s=!0})(),n.resume(),i=!0,a.textContent="STOP")};window.addEventListener("load",(async()=>{let s=document.querySelector("webgpu-audio");u=s.shadowRoot.getElementById("message-view"),(e=>{let t=!0;return"object"!=typeof navigator.gpu&&(e.textContent+="ERROR: WebGPU is not available on your browser.\r\n",t=!1),"function"!=typeof SharedArrayBuffer&&(e.textContent+="ERROR: SharedArrayBuffer is not available on your browser.\r\n",t=!1),t&&(e.textContent+="All requirements have been met. The experiment is ready to run.\r\n"),t})(u)&&(n=await(async()=>{const n=new AudioContext;await n.audioWorklet.addModule("/component/webgpu-audio/views/mjs/audio/basic-processor.js");const r=new OscillatorNode(n),s=new AudioWorkletNode(n,"basic-processor",{processorOptions:{inputQueue:e,outputQueue:t,atomicState:o}});return n.suspend(),r.connect(s).connect(n.destination),r.start(),console.log("[main.js] initializeAudio()"),n})(),r=new Worker("/component/webgpu-audio/views/mjs/audio/worker.js",{type:"module"}),r.onerror=e=>{console.log("[main.js] Error from worker.js: ",e)},l=s.shadowRoot.getElementById("select-impulse-response"),l&&(Assets.forEach((e=>{const t=document.createElement("option");t.value=e.path,t.textContent=e.label,l.appendChild(t)})),l.disabled=!1),a=s.shadowRoot.getElementById("toggle-audio"),a.onclick=d,a.disabled=!1,console.log("[main.js] window onloaded"))}))};